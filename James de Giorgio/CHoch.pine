//@version=5
indicator("Choch", overlay=true, max_lines_count=500, max_labels_count=500)

barsBack = input.int(1000, "Bars back", minval=1)
showLabels = input.bool(false, "Show labels H/L")
highLabelColor = input.color(color.new(color.green, 0), "H label color")
lowLabelColor = input.color(color.new(color.red, 0), "L label color")
labelTextColor = input.color(color.white, "Label text color")

var bool processingStarted = false
var bool haveHigh = false
var bool haveLow = false
var float currentHPrice = na
var int currentHIndex = na
var float currentLPrice = na
var int currentLIndex = na
var int currentHTime = na
var int currentLTime = na
var float lowestSinceHPrice = na
var int lowestSinceHIndex = na
var int lowestSinceHTime = na
var float highestSinceLPrice = na
var int highestSinceLIndex = na
var int highestSinceLTime = na
var bool highBreakLineDrawn = false
var bool lowBreakLineDrawn = false

if not processingStarted and bar_index >= barsBack
    processingStarted := true

if processingStarted
    // Determine the first qualifying high and low once the processing window is reached.
    pivotHigh = ta.pivothigh(high, 1, 1)
    if not haveHigh and not na(pivotHigh)
        currentHPrice := high[1]
        currentHIndex := bar_index[1]
        currentHTime := time[1]
        lowestSinceHPrice := low[1]
        lowestSinceHIndex := bar_index[1]
        lowestSinceHTime := time[1]
        haveHigh := true
        highBreakLineDrawn := false
        if showLabels
            label.new(
              currentHIndex,
              currentHPrice,
              "H",
              xloc=xloc.bar_index,
              style=label.style_label_down,
              color=highLabelColor,
              textcolor=labelTextColor,
              textalign=text.align_center)

    pivotLow = ta.pivotlow(low, 1, 1)
    if not haveLow and not na(pivotLow)
        currentLPrice := low[1]
        currentLIndex := bar_index[1]
        currentLTime := time[1]
        highestSinceLPrice := high[1]
        highestSinceLIndex := bar_index[1]
        highestSinceLTime := time[1]
        haveLow := true
        lowBreakLineDrawn := false
        if showLabels
            label.new(
              currentLIndex,
              currentLPrice,
              "L",
              xloc=xloc.bar_index,
              style=label.style_label_up,
              color=lowLabelColor,
              textcolor=labelTextColor,
              textalign=text.align_center)

    // Only treat breakouts as new pivots when the breakout candle is also a pivot relative to its neighbors.
    if haveHigh and not na(pivotHigh) and pivotHigh > currentHPrice
        newHPrice = pivotHigh
        newHIndex = bar_index[1]
        newHTime = time[1]
        oldHPrice = currentHPrice
        oldHIndex = currentHIndex
        oldHTime = currentHTime
        if showLabels
            label.new(
              newHIndex,
              newHPrice,
              "H",
              xloc=xloc.bar_index,
              style=label.style_label_down,
              color=highLabelColor,
              textcolor=labelTextColor,
              textalign=text.align_center)
        currentHPrice := newHPrice
        currentHIndex := newHIndex
        currentHTime := newHTime
        highBreakLineDrawn := false
        if not na(lowestSinceHPrice)
            if showLabels
                label.new(
                  lowestSinceHIndex,
                  lowestSinceHPrice,
                  "L",
                  xloc=xloc.bar_index,
                  style=label.style_label_up,
                  color=lowLabelColor,
                  textcolor=labelTextColor,
                  textalign=text.align_center)
            currentLPrice := lowestSinceHPrice
            currentLIndex := lowestSinceHIndex
            currentLTime := lowestSinceHTime
            haveLow := true
            lowBreakLineDrawn := false
        else
            if showLabels
                label.new(
                  bar_index,
                  low,
                  "L",
                  xloc=xloc.bar_index,
                  style=label.style_label_up,
                  color=lowLabelColor,
                  textcolor=labelTextColor,
                  textalign=text.align_center)
            currentLPrice := low
            currentLIndex := bar_index
            currentLTime := time
            haveLow := true
            lowBreakLineDrawn := false
        highestSinceLPrice := currentHPrice
        highestSinceLIndex := currentHIndex
        highestSinceLTime := currentHTime
        lowestSinceHPrice := na
        lowestSinceHIndex := na
        lowestSinceHTime := na

    if haveLow and not na(pivotLow) and pivotLow < currentLPrice
        newLPrice = pivotLow
        newLIndex = bar_index[1]
        newLTime = time[1]
        oldLPrice = currentLPrice
        oldLIndex = currentLIndex
        oldLTime = currentLTime
        if showLabels
            label.new(
              newLIndex,
              newLPrice,
              "L",
              xloc=xloc.bar_index,
              style=label.style_label_up,
              color=lowLabelColor,
              textcolor=labelTextColor,
              textalign=text.align_center)
        currentLPrice := newLPrice
        currentLIndex := newLIndex
        currentLTime := newLTime
        lowBreakLineDrawn := false
        if not na(highestSinceLPrice)
            if showLabels
                label.new(
                  highestSinceLIndex,
                  highestSinceLPrice,
                  "H",
                  xloc=xloc.bar_index,
                  style=label.style_label_down,
                  color=highLabelColor,
                  textcolor=labelTextColor,
                  textalign=text.align_center)
            currentHPrice := highestSinceLPrice
            currentHIndex := highestSinceLIndex
            currentHTime := highestSinceLTime
            haveHigh := true
            highBreakLineDrawn := false
        else
            if showLabels
                label.new(
                  bar_index,
                  high,
                  "H",
                  xloc=xloc.bar_index,
                  style=label.style_label_down,
                  color=highLabelColor,
                  textcolor=labelTextColor,
                  textalign=text.align_center)
            currentHPrice := high
            currentHIndex := bar_index
            currentHTime := time
            haveHigh := true
            highBreakLineDrawn := false
        highestSinceLPrice := na
        highestSinceLIndex := na
        highestSinceLTime := na
        lowestSinceHPrice := currentLPrice
        lowestSinceHIndex := currentLIndex
        lowestSinceHTime := currentLTime

    // Update the running extremes between the latest H and L using data from the current bar.
    if haveHigh and bar_index > currentHIndex
        if na(lowestSinceHPrice) or low < lowestSinceHPrice
            lowestSinceHPrice := low
            lowestSinceHIndex := bar_index
            lowestSinceHTime := time

    if haveLow and bar_index > currentLIndex
        if na(highestSinceLPrice) or high > highestSinceLPrice
            highestSinceLPrice := high
            highestSinceLIndex := bar_index
            highestSinceLTime := time

    // Draw horizontal lines from the current pivots until the first candle breaks them.
    if haveHigh and not highBreakLineDrawn and high > currentHPrice
        line.new(
          x1=currentHTime,
          y1=currentHPrice,
          x2=time,
          y2=currentHPrice,
          xloc=xloc.bar_time,
          extend=extend.none,
          color=highLabelColor,
          width=1)
        highBreakLineDrawn := true

    if haveLow and not lowBreakLineDrawn and low < currentLPrice
        line.new(
          x1=currentLTime,
          y1=currentLPrice,
          x2=time,
          y2=currentLPrice,
          xloc=xloc.bar_time,
          extend=extend.none,
          color=lowLabelColor,
          width=1)
        lowBreakLineDrawn := true
